<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Management System | Admin Portal</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #4361ee;
        --primary-dark: #3a56d4;
        --secondary: #7209b7;
        --success: #06d6a0;
        --warning: #ffd166;
        --danger: #ef476f;
        --info: #4cc9f0;
        --light: #f8f9fa;
        --dark: #212529;
        --gray: #6c757d;
        --gray-light: #e9ecef;
        --border: #dee2e6;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
        --radius: 12px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: #f5f7fb;
        color: var(--dark);
        line-height: 1.6;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Header Styles */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px;
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .header h1 {
        font-weight: 700;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.8rem;
      }

      .header h1 i {
        color: var(--primary);
        background: rgba(67, 97, 238, 0.1);
        padding: 10px;
        border-radius: 10px;
      }

      .header-actions {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
        background: var(--light);
        padding: 8px 20px;
        border-radius: 50px;
        transition: all 0.3s;
      }

      .user-info:hover {
        background: var(--gray-light);
      }

      .user-info img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--primary);
      }

      .notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: var(--danger);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: bold;
      }

      /* Stats Cards */
      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        border-radius: var(--radius);
        padding: 25px;
        box-shadow: var(--shadow);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
      }

      .stat-card.primary::before { background: var(--primary); }
      .stat-card.secondary::before { background: var(--secondary); }
      .stat-card.success::before { background: var(--success); }
      .stat-card.info::before { background: var(--info); }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
      }

      .stat-card .stat-icon {
        font-size: 2.5rem;
        margin-bottom: 15px;
        opacity: 0.8;
      }

      .stat-card.primary .stat-icon { color: var(--primary); }
      .stat-card.secondary .stat-icon { color: var(--secondary); }
      .stat-card.success .stat-icon { color: var(--success); }
      .stat-card.info .stat-icon { color: var(--info); }

      .stat-card .stat-value {
        font-size: 2.8rem;
        font-weight: 800;
        margin: 10px 0;
        line-height: 1;
      }

      .stat-card .stat-label {
        color: var(--gray);
        font-size: 0.95rem;
        font-weight: 500;
        margin-bottom: 5px;
      }

      .stat-trend {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.85rem;
        margin-top: 10px;
      }

      .trend-up { color: var(--success); }
      .trend-down { color: var(--danger); }

      /* Department Cards */
      .department-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .department-card {
        background: white;
        border-radius: var(--radius);
        padding: 25px;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        border-left: 4px solid var(--primary);
      }

      .department-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
      }

      .department-card .dept-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .department-card .dept-code {
        background: var(--primary);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .department-card .dept-name {
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 5px;
      }

      .department-card .dept-manager {
        color: var(--gray);
        font-size: 0.9rem;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .department-card .dept-stats {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid var(--border);
      }

      /* Filter Section */
      .filter-section {
        background: white;
        border-radius: var(--radius);
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: var(--shadow);
      }

      .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .filter-group label {
        font-weight: 500;
        font-size: 0.9rem;
        color: var(--gray);
      }

      .filter-group select,
      .filter-group input {
        padding: 10px 15px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.9rem;
        transition: all 0.3s;
      }

      .filter-group select:focus,
      .filter-group input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
      }

      /* Employee Table */
      .card {
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        margin-bottom: 30px;
      }

      .card-header {
        padding: 25px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
      }

      .card-header h3 {
        font-weight: 600;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .card-actions {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .search-box {
        position: relative;
        min-width: 300px;
      }

      .search-box input {
        width: 100%;
        padding: 12px 15px 12px 45px;
        border: 1px solid var(--border);
        border-radius: 50px;
        font-size: 0.95rem;
        transition: all 0.3s;
      }

      .search-box input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
      }

      .search-box i {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray);
      }

      .table-container {
        overflow-x: auto;
      }

      .employee-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1000px;
      }

      .employee-table thead {
        background-color: var(--light);
      }

      .employee-table th {
        padding: 18px 25px;
        text-align: left;
        font-weight: 600;
        color: var(--dark);
        border-bottom: 2px solid var(--border);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .employee-table td {
        padding: 20px 25px;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
      }

      .employee-table tbody tr {
        transition: background-color 0.2s;
      }

      .employee-table tbody tr:hover {
        background-color: rgba(67, 97, 238, 0.05);
      }

      .employee-table tbody tr.active {
        background-color: rgba(6, 214, 160, 0.1);
      }

      .employee-table tbody tr.inactive {
        background-color: rgba(239, 71, 111, 0.05);
        opacity: 0.8;
      }

      .employee-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--primary);
      }

      .employee-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .employee-details {
        display: flex;
        flex-direction: column;
      }

      .employee-name {
        font-weight: 600;
        font-size: 1rem;
      }

      .employee-username {
        font-size: 0.85rem;
        color: var(--gray);
        margin-top: 2px;
      }

      .badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        letter-spacing: 0.3px;
      }

      .badge-primary {
        background-color: rgba(67, 97, 238, 0.1);
        color: var(--primary);
      }

      .badge-secondary {
        background-color: rgba(114, 9, 183, 0.1);
        color: var(--secondary);
      }

      .badge-success {
        background-color: rgba(6, 214, 160, 0.1);
        color: var(--success);
      }

      .badge-warning {
        background-color: rgba(255, 209, 102, 0.1);
        color: #e6b400;
      }

      .badge-danger {
        background-color: rgba(239, 71, 111, 0.1);
        color: var(--danger);
      }

      .role-badge {
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 15px;
        font-weight: 500;
      }

      .role-employee { background: #e3f2fd; color: #1976d2; }
      .role-manager { background: #e8f5e9; color: #2e7d32; }
      .role-admin { background: #fce4ec; color: #c2185b; }

      .action-buttons {
        display: flex;
        gap: 8px;
      }

      .btn {
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-sm {
        padding: 8px 12px;
        font-size: 0.85rem;
      }

      .btn-xs {
        padding: 6px 10px;
        font-size: 0.8rem;
      }

      .btn-primary {
        background-color: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background-color: var(--primary-dark);
        transform: translateY(-2px);
      }

      .btn-success {
        background-color: var(--success);
        color: white;
      }

      .btn-outline {
        background-color: transparent;
        border: 1px solid var(--border);
        color: var(--gray);
      }

      .btn-outline:hover {
        background-color: var(--gray-light);
      }

      .btn-icon {
        width: 36px;
        height: 36px;
        padding: 0;
        justify-content: center;
        border-radius: 50%;
      }

      /* Pagination */
      .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 25px;
        border-top: 1px solid var(--border);
        background: white;
      }

      .pagination-info {
        color: var(--gray);
        font-size: 0.9rem;
      }

      .pagination-controls {
        display: flex;
        gap: 8px;
      }

      .pagination-controls a {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background-color: var(--light);
        border: 1px solid var(--border);
        color: var(--gray);
        text-decoration: none;
        transition: all 0.2s;
        font-weight: 500;
      }

      .pagination-controls a:hover {
        background-color: var(--primary);
        color: white;
        border-color: var(--primary);
        transform: translateY(-2px);
      }

      .pagination-controls a.active {
        background-color: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      .pagination-controls .disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Footer */
      .footer {
        text-align: center;
        padding: 25px;
        color: var(--gray);
        font-size: 0.9rem;
        border-top: 1px solid var(--border);
        margin-top: 30px;
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--gray);
      }

      .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .empty-state h3 {
        font-size: 1.5rem;
        margin-bottom: 10px;
        color: var(--dark);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        .header {
          flex-direction: column;
          align-items: stretch;
          gap: 20px;
          padding: 20px 15px;
        }

        .header-left {
          flex-direction: column;
          align-items: flex-start;
        }

        .header-actions {
          flex-direction: column;
          width: 100%;
        }

        .search-box {
          min-width: 100%;
        }

        .card-header {
          flex-direction: column;
          align-items: stretch;
        }

        .card-actions {
          flex-direction: column;
          width: 100%;
        }

        .stats-container {
          grid-template-columns: 1fr;
        }

        .department-cards {
          grid-template-columns: 1fr;
        }

        .filter-grid {
          grid-template-columns: 1fr;
        }

        .pagination {
          flex-direction: column;
          gap: 15px;
        }
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: var(--radius);
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
        animation: modalSlideIn 0.3s ease;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-50px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-header {
        padding: 25px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-body {
        padding: 25px;
      }

      .modal-footer {
        padding: 20px 25px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--gray);
        transition: color 0.3s;
      }

      .close-modal:hover {
        color: var(--danger);
      }

      /* Loading Spinner */
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--gray-light);
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .error-messages {
  margin-top: 5px;
}

.error-messages div {
  color: var(--danger);
  font-size: 0.85rem;
  padding: 8px 12px;
  background: rgba(239, 71, 111, 0.1);
  border-radius: 8px;
  margin-top: 5px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.error-messages div i {
  font-size: 0.8rem;
}

.form-control {
  width: 100%;
  padding: 10px 15px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 0.95rem;
  transition: all 0.3s;
}

.form-control:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
}

.form-control.is-invalid {
  border-color: var(--danger);
  box-shadow: 0 0 0 3px rgba(239, 71, 111, 0.1);
}

.form-group {
  margin-bottom: 15px;
}
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="header-left">
          <h1><i class="fas fa-users-cog"></i> Employee Management System</h1>
          <div class="user-info">
            <div style="position: relative;">
              <img
                src="https://ui-avatars.com/api/?name=Admin+User&background=4361ee&color=fff&size=40"
                alt="Admin User"
              />
              <div class="notification-badge">3</div>
            </div>
            <div>
              <div style="font-weight: 600">Admin User</div>
              <div style="font-size: 0.85rem; color: var(--gray)">Super Administrator</div>
            </div>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showAddEmployeeModal()">
            <i class="fas fa-user-plus"></i> Add Employee
          </button>
         <a href="{% url 'emp:manage_departments' %}" class="btn btn-outline" style="text-decoration: none;">
    <i class="fas fa-building"></i> Manage Departments
</a>
          <button class="btn btn-outline" onclick="exportData()">
            <i class="fas fa-download"></i> Export
          </button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="stats-container">
        <div class="stat-card primary">
          <div class="stat-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-value">{{ emp_count }}</div>
          <div class="stat-label">Total Employees</div>
          <div class="stat-trend">
            <i class="fas fa-arrow-up trend-up"></i>
            <span>{{ new_hires_this_month }} new this month</span>
          </div>
        </div>
        <div class="stat-card secondary">
          <div class="stat-icon">
            <i class="fas fa-building"></i>
          </div>
          <div class="stat-value">{{ total_departments }}</div>
          <div class="stat-label">Active Departments</div>
          <div class="stat-trend">
            <i class="fas fa-users"></i>
            <span>{{ avg_employees_per_dept }} avg per dept</span>
          </div>
        </div>
        <div class="stat-card success">
          <div class="stat-icon">
            <i class="fas fa-user-check"></i>
          </div>
          <div class="stat-value">{{ active_employees }}</div>
          <div class="stat-label">Active Employees</div>
          <div class="stat-trend">
            <span>{{ active_percentage }}% active rate</span>
          </div>
        </div>
        <div class="stat-card info">
          <div class="stat-icon">
            <i class="fas fa-user-tie"></i>
          </div>
          <div class="stat-value">{{ managers_count }}</div>
          <div class="stat-label">Managers</div>
          <div class="stat-trend">
            <i class="fas fa-chart-line"></i>
            <span>{{ managers_percentage }}% of total</span>
          </div>
        </div>
      </div>

      <!-- Filter Section -->
      <div class="filter-section">
        <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
          <i class="fas fa-filter"></i> Filter Employees
        </h3>
        <form method="GET" action="">
          <div class="filter-grid">
            <div class="filter-group">
              <label for="department"><i class="fas fa-building"></i> Department</label>
              <select name="department" id="department">
                <option value="">All Departments</option>
                {% for dept in departments %}
                <option value="{{ dept.id }}" {% if selected_department == dept.id|stringformat:"s" %}selected{% endif %}>
                  {{ dept.name }} ({{ dept.code }})
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="filter-group">
              <label for="role"><i class="fas fa-user-tag"></i> Role</label>
              <select name="role" id="role">
                <option value="">All Roles</option>
                <option value="employee" {% if selected_role == 'employee' %}selected{% endif %}>Employee</option>
                <option value="manager" {% if selected_role == 'manager' %}selected{% endif %}>Manager</option>
                <option value="admin" {% if selected_role == 'admin' %}selected{% endif %}>Administrator</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="status"><i class="fas fa-circle"></i> Status</label>
              <select name="status" id="status">
                <option value="">All Status</option>
                <option value="active" {% if selected_status == 'active' %}selected{% endif %}>Active</option>
                <option value="inactive" {% if selected_status == 'inactive' %}selected{% endif %}>Inactive</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="search"><i class="fas fa-search"></i> Search</label>
              <input 
                type="text" 
                name="q" 
                id="search" 
                placeholder="Search by name, username, or phone..."
                value="{{ search_query }}"
              >
            </div>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-filter"></i> Apply Filters
            </button>
            <a href="{% url 'emp:home_page' %}" class="btn btn-outline">
              <i class="fas fa-times"></i> Clear Filters
            </a>
          </div>
        </form>
      </div>

      <!-- Department Cards -->
      {% if departments %}
      <div class="department-cards">
        {% for dept in departments %}
        <div class="department-card">
          <div class="dept-header">
            <div class="dept-code">{{ dept.code }}</div>
            {% if dept.is_active %}
            <span class="badge badge-success">Active</span>
            {% else %}
            <span class="badge badge-danger">Inactive</span>
            {% endif %}
          </div>
          <div class="dept-name">{{ dept.name }}</div>
          <div class="dept-manager">
            <i class="fas fa-user-tie"></i>
            {% if dept.manager %}
            {{ dept.manager.user.get_full_name|default:dept.manager.user.username }}
            {% else %}
            No Manager Assigned
            {% endif %}
          </div>
          {% if dept.description %}
          <p style="font-size: 0.9rem; color: var(--gray); margin-top: 10px;">
            {{ dept.description|truncatewords:20 }}
          </p>
          {% endif %}
          <div class="dept-stats">
            <div style="text-align: center;">
              <div style="font-size: 1.5rem; font-weight: 700;">{{ dept.employee_count }}</div>
              <div style="font-size: 0.8rem; color: var(--gray);">Employees</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 1.5rem; font-weight: 700;">
                {{ dept.get_active_employees.count|default:0 }}
              </div>
              <div style="font-size: 0.8rem; color: var(--gray);">Active</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 1.5rem; font-weight: 700;">
                {{ dept.created_at|date:"M Y" }}
              </div>
              <div style="font-size: 0.8rem; color: var(--gray);">Created</div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Employee Table -->
      <div class="card">
        <div class="card-header">
          <h3><i class="fas fa-list"></i> Employee Directory</h3>
          <div class="card-actions">
            <div class="search-box">
              <i class="fas fa-search"></i>
              <input type="text" id="live-search" placeholder="Live search employees...">
            </div>
            <button class="btn btn-outline" onclick="toggleView()">
              <i class="fas fa-th"></i> Grid View
            </button>
            <button class="btn btn-outline" onclick="refreshData()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>

        <div class="table-container">
          <table class="employee-table">
            <thead>
              <tr>
                <th>Employee</th>
                <th>Contact</th>
                <th>Department</th>
                <th>Role</th>
                <th>Status</th>
                <th>Joined</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="employee-table-body">
              {% for emp in emp_details %}
              <tr class="{% if emp.is_active %}active{% else %}inactive{% endif %}" data-employee-id="{{ emp.id }}">
                <td>
                  <div class="employee-info">
                    <img 
                      class="employee-avatar"
                      src="https://ui-avatars.com/api/?name={{ emp.user.get_full_name|default:emp.user.username }}&background=random&size=45"
                      alt="{{ emp.user.username }}"
                      onerror="this.src='https://ui-avatars.com/api/?name=User&background=4361ee&color=fff&size=45'"
                    />
                    <div class="employee-details">
                      <div class="employee-name">
                        {% if emp.user.get_full_name %}
                          {{ emp.user.get_full_name }}
                        {% else %}
                          {{ emp.user.username|title }}
                        {% endif %}
                      </div>
                      <div class="employee-username">@{{ emp.user.username }}</div>
                      <div style="font-size: 0.8rem; color: var(--gray);">
                        <i class="fas fa-envelope"></i> {{ emp.user.email|default:"No email" }}
                      </div>
                    </div>
                  </div>
                </td>
                <td>
                  <div style="font-weight: 500;">
                    <i class="fas fa-phone"></i> {{ emp.phone_number }}
                  </div>
                  <div style="font-size: 0.85rem; color: var(--gray); margin-top: 5px;">
                    <i class="fas fa-map-marker-alt"></i> {{ emp.address|truncatechars:30 }}
                  </div>
                </td>
                <td>
                  {% if emp.department %}
                  <span class="badge badge-primary" title="{{ emp.department.name }}">
                    <i class="fas fa-building"></i> {{ emp.department.name }}
                    <small>({{ emp.department.code }})</small>
                  </span>
                  {% else %}
                  <span class="badge badge-warning">No Department</span>
                  {% endif %}
                </td>
                <td>
                  <span class="role-badge role-{{ emp.role }}">
                    <i class="fas fa-user-tag"></i> {{ emp.get_role_display }}
                  </span>
                </td>
                <td>
                  {% if emp.is_active %}
                  <span class="badge badge-success">
                    <i class="fas fa-check-circle"></i> Active
                  </span>
                  {% else %}
                  <span class="badge badge-danger">
                    <i class="fas fa-times-circle"></i> Inactive
                  </span>
                  {% endif %}
                </td>
                <td>
                  <div style="font-weight: 500;">{{ emp.created_at|date:"M d, Y" }}</div>
                  <div style="font-size: 0.85rem; color: var(--gray);">
                    {{ emp.created_at|timesince }} ago
                  </div>
                </td>
                <td>
                 <div class="action-buttons">
    <button class="btn btn-primary btn-xs btn-icon" onclick="viewEmployee('{{ emp.id }}')" title="View">
        <i class="fas fa-eye"></i>
    </button>
    <button class="btn btn-outline btn-xs btn-icon" onclick="editEmployee('{{ emp.id }}')" title="Edit">
        <i class="fas fa-edit"></i>
    </button>
    <button class="btn btn-outline btn-xs btn-icon" onclick="sendMessage('{{ emp.id }}')" title="Message">
        <i class="fas fa-envelope"></i>
    </button>
    {% if emp.is_active %}
    <button class="btn btn-outline btn-xs btn-icon" onclick="toggleEmployeeStatus('{{ emp.id }}', 'deactivate')" title="Deactivate">
        <i class="fas fa-user-slash"></i>
    </button>
    {% else %}
    <button class="btn btn-success btn-xs btn-icon" onclick="toggleEmployeeStatus('{{ emp.id }}', 'activate')" title="Activate">
        <i class="fas fa-user-check"></i>
    </button>
    {% endif %}
    <button class="btn btn-outline btn-xs btn-icon" onclick="deleteEmployee('{{ emp.id }}')" title="Delete" style="color: var(--danger); border-color: var(--danger);">
        <i class="fas fa-trash"></i>
    </button>
</div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7">
                  <div class="empty-state">
                    <i class="fas fa-users-slash"></i>
                    <h3>No employees found</h3>
                    <p>Try adjusting your filters or add new employees.</p>
                    <button class="btn btn-primary" onclick="showAddEmployeeModal()" style="margin-top: 15px;">
                      <i class="fas fa-user-plus"></i> Add First Employee
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        {% if page_obj and page_obj.has_other_pages %}
        <div class="pagination">
          <div class="pagination-info">
            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} entries
          </div>
          <div class="pagination-controls">
            {% if page_obj.has_previous %}
              <a href="?page=1{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_department %}&department={{ selected_department }}{% endif %}{% if selected_role %}&role={{ selected_role }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">
                <i class="fas fa-angle-double-left"></i>
              </a>
              <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_department %}&department={{ selected_department }}{% endif %}{% if selected_role %}&role={{ selected_role }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">
                <i class="fas fa-angle-left"></i>
              </a>
            {% else %}
              <a class="disabled"><i class="fas fa-angle-double-left"></i></a>
              <a class="disabled"><i class="fas fa-angle-left"></i></a>
            {% endif %}

            {% for i in page_obj.paginator.page_range %}
              {% if page_obj.number == i %}
                <a class="active">{{ i }}</a>
              {% else %}
                <a href="?page={{ i }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_department %}&department={{ selected_department }}{% endif %}{% if selected_role %}&role={{ selected_role }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">{{ i }}</a>
              {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
              <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_department %}&department={{ selected_department }}{% endif %}{% if selected_role %}&role={{ selected_role }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">
                <i class="fas fa-angle-right"></i>
              </a>
              <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_department %}&department={{ selected_department }}{% endif %}{% if selected_role %}&role={{ selected_role }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">
                <i class="fas fa-angle-double-right"></i>
              </a>
            {% else %}
              <a class="disabled"><i class="fas fa-angle-right"></i></a>
              <a class="disabled"><i class="fas fa-angle-double-right"></i></a>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Footer -->
      <div class="footer">
        <p>
          <strong>Employee Management System</strong> | v2.5.0 | 
          Last updated: {{ current_time|date:"F j, Y, g:i a" }}
        </p>
        <p style="margin-top: 10px; font-size: 0.8rem; color: var(--gray);">
          <i class="fas fa-database"></i> {{ total_employees }} employees | 
          <i class="fas fa-building"></i> {{ total_departments }} departments |
          <i class="fas fa-server"></i> Localhost
        </p>
      </div>
    </div>

    <!-- Employee Detail Modal -->
    <div id="employeeModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-user-circle"></i> Employee Details</h3>
          <button class="close-modal" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="employeeModalBody">
          <!-- Dynamic content will be loaded here -->
          <div class="spinner"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeModal()">Close</button>
          <button class="btn btn-primary" onclick="editEmployee(selectedEmployeeId)">Edit</button>
        </div>
      </div>
    </div>
<!-- Add Employee Modal -->
<div id="addEmployeeModal" class="modal">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h3><i class="fas fa-user-plus"></i> Add New Employee</h3>
      <button class="close-modal" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="addEmployeeForm" method="POST" action="{% url 'emp:add_employee' %}">
        {% csrf_token %}
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
          <!-- Username -->
          <div class="form-group">
            <label for="id_username" style="display: block; margin-bottom: 5px; font-weight: 500;">
              Username <span style="color: var(--danger);">*</span>
            </label>
            <input 
              type="text" 
              name="username" 
              id="id_username" 
              class="form-control"
              required
              placeholder="e.g., BiswasPokhrel"
            >
            <small style="display: block; margin-top: 5px; color: var(--gray); font-size: 0.85rem;">
              Required. 150 characters or fewer. Letters, digits and @/./+/-/_ only.
            </small>
            <div id="username-errors" class="error-messages"></div>
          </div>

          <!-- Email -->
          <div class="form-group">
            <label for="id_email" style="display: block; margin-bottom: 5px; font-weight: 500;">
              Email <span style="color: var(--danger);">*</span>
            </label>
            <input 
              type="email" 
              name="email" 
              id="id_email" 
              class="form-control"
              required
              placeholder="e.g., BiswasPokhrel@example.com"
            >
            <div id="email-errors" class="error-messages"></div>
          </div>

          <!-- First Name -->
          <div class="form-group">
            <label for="id_first_name" style="display: block; margin-bottom: 5px; font-weight: 500;">
              First Name
            </label>
            <input 
              type="text" 
              name="first_name" 
              id="id_first_name" 
              class="form-control"
              placeholder="Biswas"
            >
          </div>

          <!-- Last Name -->
          <div class="form-group">
            <label for="id_last_name" style="display: block; margin-bottom: 5px; font-weight: 500;">
              Last Name
            </label>
            <input 
              type="text" 
              name="last_name" 
              id="id_last_name" 
              class="form-control"
              placeholder="Pokhrel"
            >
          </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
          <!-- Password -->
          <div class="form-group">
            <label for="id_password1" style="display: block; margin-bottom: 5px; font-weight: 500;">
              Password <span style="color: var(--danger);">*</span>
            </label>
            <input 
              type="password" 
              name="password1" 
              id="id_password1" 
              class="form-control"
              required
            >
            <div class="password-strength" style="margin-top: 10px;">
              <div class="strength-meter" style="height: 6px; background: var(--gray-light); border-radius: 3px; margin-bottom: 5px;">
                <div id="passwordStrengthFill" style="height: 100%; width: 0%; background: var(--danger); border-radius: 3px;"></div>
              </div>
              <div id="passwordStrengthText" style="font-size: 0.85rem; color: var(--gray);">
                Password strength
              </div>
            </div>
            <div id="password1-errors" class="error-messages"></div>
          </div>

          <!-- Confirm Password -->
          <div class="form-group">
            <label for="id_password2" style="display: block; margin-bottom: 5px; font-weight: 500;">
              Confirm Password <span style="color: var(--danger);">*</span>
            </label>
            <input 
              type="password" 
              name="password2" 
              id="id_password2" 
              class="form-control"
              required
            >
            <div id="password2-errors" class="error-messages"></div>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
          <!-- Phone Number -->
          <div class="form-group">
            <label for="id_phone_number" style="display: block; margin-bottom: 5px; font-weight: 500;">
              Phone Number <span style="color: var(--danger);">*</span>
            </label>
            <input 
              type="number" 
              name="phone_number" 
              id="id_phone_number" 
              class="form-control"
              required
              placeholder="9876543210"
              min="1000000000"
              max="999999999999999"
            >
            <small style="display: block; margin-top: 5px; color: var(--gray); font-size: 0.85rem;">
              Enter 10-15 digit phone number
            </small>
            <div id="phone-errors" class="error-messages"></div>
          </div>

          <!-- Department -->
          <div class="form-group">
            <label for="id_department" style="display: block; margin-bottom: 5px; font-weight: 500;">
              Department
            </label>
            <select name="department" id="id_department" class="form-control">
              <option value="">Select Department</option>
              {% for dept in departments %}
                <option value="{{ dept.id }}">{{ dept.name }} ({{ dept.code }})</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Address -->
        <div class="form-group" style="margin-bottom: 20px;">
          <label for="id_address" style="display: block; margin-bottom: 5px; font-weight: 500;">
            Address <span style="color: var(--danger);">*</span>
          </label>
          <textarea 
            name="address" 
            id="id_address" 
            class="form-control" 
            rows="3" 
            maxlength="100" 
            required
            placeholder="Enter full address"
          ></textarea>
          <div class="char-count" style="display: flex; justify-content: space-between; margin-top: 5px;">
            <small style="color: var(--gray); font-size: 0.85rem;">Maximum 100 characters</small>
            <span id="addressCharCount" style="font-size: 0.85rem; color: var(--gray);">0/100</span>
          </div>
          <div id="address-errors" class="error-messages"></div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
          <!-- Role -->
          <div class="form-group">
            <label for="id_role" style="display: block; margin-bottom: 5px; font-weight: 500;">
              Role <span style="color: var(--danger);">*</span>
            </label>
            <select name="role" id="id_role" class="form-control" required>
              <option value="employee">Employee</option>
              <option value="manager">Manager</option>
              <option value="admin">Administrator</option>
            </select>
          </div>

          <!-- Status -->
          <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 25px;">
            <input 
              type="checkbox" 
              name="is_active" 
              id="id_is_active" 
              checked
              style="width: 18px; height: 18px; accent-color: var(--primary);"
            >
            <label for="id_is_active" style="font-weight: 500;">
              Active Account
            </label>
          </div>
        </div>

        <!-- Avatar Preview -->
        <div style="text-align: center; margin-bottom: 30px; padding: 20px; background: var(--light); border-radius: var(--radius);">
          <div id="avatarPreview" style="width: 100px; height: 100px; margin: 0 auto 15px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-light) 0%, var(--info) 100%); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: white;">
            <i class="fas fa-user"></i>
          </div>
          <small style="color: var(--gray); font-size: 0.85rem;">
            Avatar will be generated from the name
          </small>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitEmployeeBtn">
            <span class="btn-text">Add Employee</span>
            <div class="loader" style="display: none; width: 20px; height: 20px; border: 3px solid white; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Edit Employee Modal -->
<div id="editEmployeeModal" class="modal">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h3><i class="fas fa-user-edit"></i> Edit Employee</h3>
      <button class="close-modal" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="editEmployeeForm" method="POST">
        {% csrf_token %}
        <input type="hidden" name="employee_id" id="edit_employee_id">
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
          <!-- Username (readonly) -->
          <div class="form-group">
            <label for="edit_username" style="display: block; margin-bottom: 5px; font-weight: 500;">
              Username
            </label>
            <input 
              type="text" 
              id="edit_username" 
              class="form-control"
              readonly
              style="background-color: var(--light); cursor: not-allowed;"
            >
          </div>

          <!-- Email -->
          <div class="form-group">
            <label for="edit_email" style="display: block; margin-bottom: 5px; font-weight: 500;">
              Email <span style="color: var(--danger);">*</span>
            </label>
            <input 
              type="email" 
              name="email" 
              id="edit_email" 
              class="form-control"
              required
            >
            <div id="edit_email-errors" class="error-messages"></div>
          </div>

          <!-- First Name -->
          <div class="form-group">
            <label for="edit_first_name" style="display: block; margin-bottom: 5px; font-weight: 500;">
              First Name
            </label>
            <input 
              type="text" 
              name="first_name" 
              id="edit_first_name" 
              class="form-control"
            >
          </div>

          <!-- Last Name -->
          <div class="form-group">
            <label for="edit_last_name" style="display: block; margin-bottom: 5px; font-weight: 500;">
              Last Name
            </label>
            <input 
              type="text" 
              name="last_name" 
              id="edit_last_name" 
              class="form-control"
            >
          </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
          <!-- Phone Number -->
          <div class="form-group">
            <label for="edit_phone_number" style="display: block; margin-bottom: 5px; font-weight: 500;">
              Phone Number <span style="color: var(--danger);">*</span>
            </label>
            <input 
              type="number" 
              name="phone_number" 
              id="edit_phone_number" 
              class="form-control"
              required
              min="1000000000"
              max="999999999999999"
            >
            <div id="edit_phone-errors" class="error-messages"></div>
          </div>

          <!-- Department -->
          <div class="form-group">
            <label for="edit_department" style="display: block; margin-bottom: 5px; font-weight: 500;">
              Department
            </label>
            <select name="department" id="edit_department" class="form-control">
              <option value="">Select Department</option>
              {% for dept in departments %}
                <option value="{{ dept.id }}">{{ dept.name }} ({{ dept.code }})</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Address -->
        <div class="form-group" style="margin-bottom: 20px;">
          <label for="edit_address" style="display: block; margin-bottom: 5px; font-weight: 500;">
            Address <span style="color: var(--danger);">*</span>
          </label>
          <textarea 
            name="address" 
            id="edit_address" 
            class="form-control" 
            rows="3" 
            maxlength="100" 
            required
          ></textarea>
          <div class="char-count" style="display: flex; justify-content: space-between; margin-top: 5px;">
            <small style="color: var(--gray); font-size: 0.85rem;">Maximum 100 characters</small>
            <span id="edit_addressCharCount" style="font-size: 0.85rem; color: var(--gray);">0/100</span>
          </div>
          <div id="edit_address-errors" class="error-messages"></div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
          <!-- Role -->
          <div class="form-group">
            <label for="edit_role" style="display: block; margin-bottom: 5px; font-weight: 500;">
              Role <span style="color: var(--danger);">*</span>
            </label>
            <select name="role" id="edit_role" class="form-control" required>
              <option value="employee">Employee</option>
              <option value="manager">Manager</option>
              <option value="admin">Administrator</option>
            </select>
          </div>

          <!-- Status -->
          <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 25px;">
            <input 
              type="checkbox" 
              name="is_active" 
              id="edit_is_active" 
              style="width: 18px; height: 18px; accent-color: var(--primary);"
            >
            <label for="edit_is_active" style="font-weight: 500;">
              Active Account
            </label>
          </div>
        </div>

        <!-- Password Update Section -->
        <div style="margin-bottom: 30px; padding: 20px; background: var(--light); border-radius: var(--radius);">
          <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-key"></i> Change Password (Optional)
          </h4>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
            <div class="form-group">
              <label for="edit_password1" style="display: block; margin-bottom: 5px; font-weight: 500;">
                New Password
              </label>
              <input 
                type="password" 
                name="password1" 
                id="edit_password1" 
                class="form-control"
                placeholder="Leave empty to keep current password"
              >
            </div>
            <div class="form-group">
              <label for="edit_password2" style="display: block; margin-bottom: 5px; font-weight: 500;">
                Confirm Password
              </label>
              <input 
                type="password" 
                name="password2" 
                id="edit_password2" 
                class="form-control"
                placeholder="Confirm new password"
              >
            </div>
          </div>
        </div>

        <!-- Avatar Preview -->
        <div style="text-align: center; margin-bottom: 30px; padding: 20px; background: var(--light); border-radius: var(--radius);">
          <div id="edit_avatarPreview" style="width: 100px; height: 100px; margin: 0 auto 15px; border-radius: 50%; background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: white;">
            <i class="fas fa-user"></i>
          </div>
          <small style="color: var(--gray); font-size: 0.85rem;">
            Avatar preview
          </small>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitEditEmployeeBtn">
            <span class="btn-text">Update Employee</span>
            <div class="loader" style="display: none; width: 20px; height: 20px; border: 3px solid white; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
  <script>
      let selectedEmployeeId = null;

// Get CSRF token helper function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Clear error messages
function clearErrors() {
    document.querySelectorAll('.error-messages').forEach(el => {
        el.innerHTML = '';
    });
    document.querySelectorAll('.form-control.is-invalid').forEach(el => {
        el.classList.remove('is-invalid');
    });
}

// Show error messages
function showErrors(errors) {
    clearErrors();
    
    for (const field in errors) {
        const fieldName = field === '__all__' ? 'general' : field;
        const errorContainer = document.getElementById(`${fieldName}-errors`);
        const inputField = document.getElementById(`id_${fieldName}`);
        
        if (errorContainer) {
            errors[field].forEach(error => {
                const errorDiv = document.createElement('div');
                errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${error}`;
                errorContainer.appendChild(errorDiv);
            });
        }
        
        if (inputField) {
            inputField.classList.add('is-invalid');
        }
    }
}

// Show notification
function showNotification(type, message) {
    // Remove existing notifications
    document.querySelectorAll('.notification').forEach(n => n.remove());
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${message}</span>
        </div>
        <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer;">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Style the notification
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: ${type === 'success' ? 'var(--success)' : 'var(--danger)'};
        color: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 15px;
        min-width: 300px;
        max-width: 400px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }
    }, 5000);
}

// Update avatar preview for add form
function updateAvatarPreview() {
    const firstName = document.getElementById('id_first_name')?.value || '';
    const lastName = document.getElementById('id_last_name')?.value || '';
    const fullName = `${firstName} ${lastName}`.trim() || 'User';
    const avatarPreview = document.getElementById('avatarPreview');
    
    if (avatarPreview) {
        // Create avatar with initials
        const initials = fullName.split(' ').map(n => n[0]).join('').toUpperCase();
        avatarPreview.innerHTML = `<span style="font-weight: bold; font-size: 2rem;">${initials}</span>`;
        
        // Set background color based on name
        const colors = [
            'linear-gradient(135deg, #4361ee 0%, #3a56d4 100%)',
            'linear-gradient(135deg, #7209b7 0%, #5e0896 100%)',
            'linear-gradient(135deg, #06d6a0 0%, #05c190 100%)',
            'linear-gradient(135deg, #ef476f 0%, #e6355e 100%)',
            'linear-gradient(135deg, #4cc9f0 0%, #3ab7e0 100%)',
        ];
        
        // Simple hash function to get consistent color for same name
        let hash = 0;
        for (let i = 0; i < fullName.length; i++) {
            hash = fullName.charCodeAt(i) + ((hash << 5) - hash);
        }
        const colorIndex = Math.abs(hash) % colors.length;
        
        avatarPreview.style.background = colors[colorIndex];
    }
}

// Update avatar preview for edit form
function updateEditAvatarPreview() {
    const firstName = document.getElementById('edit_first_name')?.value || '';
    const lastName = document.getElementById('edit_last_name')?.value || '';
    const fullName = `${firstName} ${lastName}`.trim() || 
                     document.getElementById('edit_username')?.value || 'User';
    
    const avatarPreview = document.getElementById('edit_avatarPreview');
    
    if (avatarPreview) {
        const initials = fullName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        avatarPreview.innerHTML = `<span style="font-weight: bold; font-size: 2rem;">${initials}</span>`;
        
        // Set consistent background color
        const colors = [
            'linear-gradient(135deg, #4361ee 0%, #3a56d4 100%)',
            'linear-gradient(135deg, #7209b7 0%, #5e0896 100%)',
            'linear-gradient(135deg, #06d6a0 0%, #05c190 100%)',
            'linear-gradient(135deg, #ef476f 0%, #e6355e 100%)',
            'linear-gradient(135deg, #4cc9f0 0%, #3ab7e0 100%)',
        ];
        
        let hash = 0;
        for (let i = 0; i < fullName.length; i++) {
            hash = fullName.charCodeAt(i) + ((hash << 5) - hash);
        }
        const colorIndex = Math.abs(hash) % colors.length;
        
        avatarPreview.style.background = colors[colorIndex];
    }
}

// Update character count for address in add form
function updateCharCount() {
    const addressField = document.getElementById('id_address');
    const charCount = document.getElementById('addressCharCount');
    
    if (addressField && charCount) {
        const currentLength = addressField.value.length;
        const maxLength = 100;
        charCount.textContent = `${currentLength}/${maxLength}`;
        
        if (currentLength > maxLength * 0.9) {
            charCount.style.color = 'var(--warning)';
        } else if (currentLength > maxLength) {
            charCount.style.color = 'var(--danger)';
        } else {
            charCount.style.color = 'var(--gray)';
        }
    }
}

// Update character count for address in edit form
function updateEditCharCount() {
    const addressField = document.getElementById('edit_address');
    const charCount = document.getElementById('edit_addressCharCount');
    
    if (addressField && charCount) {
        const currentLength = addressField.value.length;
        const maxLength = 100;
        charCount.textContent = `${currentLength}/${maxLength}`;
        
        if (currentLength > maxLength * 0.9) {
            charCount.style.color = 'var(--warning)';
        } else if (currentLength > maxLength) {
            charCount.style.color = 'var(--danger)';
        } else {
            charCount.style.color = 'var(--gray)';
        }
    }
}

// Check password strength
function checkPasswordStrength(password) {
    const strengthFill = document.getElementById('passwordStrengthFill');
    const strengthText = document.getElementById('passwordStrengthText');
    
    if (!strengthFill || !strengthText) return;
    
    let strength = 0;
    let text = '';
    let color = '';
    let width = '0%';
    
    // Check password length
    if (password.length >= 8) strength += 1;
    
    // Check for lowercase letters
    if (/[a-z]/.test(password)) strength += 1;
    
    // Check for uppercase letters
    if (/[A-Z]/.test(password)) strength += 1;
    
    // Check for numbers
    if (/[0-9]/.test(password)) strength += 1;
    
    // Check for special characters
    if (/[^A-Za-z0-9]/.test(password)) strength += 1;
    
    // Determine strength level
    if (password.length === 0) {
        text = 'Password strength';
        color = 'var(--gray)';
        width = '0%';
    } else if (strength < 2) {
        text = 'Weak';
        color = 'var(--danger)';
        width = '33%';
    } else if (strength < 4) {
        text = 'Fair';
        color = 'var(--warning)';
        width = '66%';
    } else {
        text = 'Strong';
        color = 'var(--success)';
        width = '100%';
    }
    
    strengthFill.style.width = width;
    strengthFill.style.background = color;
    strengthText.textContent = text;
    strengthText.style.color = color;
}

// Live search functionality
document.getElementById('live-search')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#employee-table-body tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// View employee details
async function viewEmployee(employeeId) {
    selectedEmployeeId = employeeId;
    const modal = document.getElementById('employeeModal');
    const modalBody = document.getElementById('employeeModalBody');
    
    modalBody.innerHTML = '<div class="spinner"></div>';
    modal.classList.add('active');
    
    try {
        // Find the employee row to get data from the table
        const row = document.querySelector(`tr[data-employee-id="${employeeId}"]`);
        if (row) {
            const employeeName = row.querySelector('.employee-name').textContent.trim();
            const username = row.querySelector('.employee-username').textContent.trim().replace('@', '');
            const email = row.querySelector('.fa-envelope').parentNode.textContent.trim();
            const phone = row.querySelector('.fa-phone').parentNode.textContent.trim();
            const address = row.querySelector('.fa-map-marker-alt').parentNode.textContent.trim();
            const department = row.querySelector('.badge-primary')?.textContent.trim() || 'No Department';
            const role = row.querySelector('.role-badge').textContent.trim();
            const status = row.querySelector('.badge-success, .badge-danger')?.textContent.trim() || 'Unknown';
            const joined = row.querySelector('td:nth-child(6) div:first-child').textContent.trim();
            
            modalBody.innerHTML = `
              <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <img 
                  src="https://ui-avatars.com/api/?name=${encodeURIComponent(employeeName)}&background=4361ee&color=fff&size=100"
                  alt="Employee Avatar"
                  style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary);"
                />
                <div>
                  <h2 style="margin-bottom: 5px;">${employeeName}</h2>
                  <p style="color: var(--gray);">@${username} | Employee ID: ${employeeId}</p>
                  <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <span class="badge badge-primary">${department}</span>
                    <span class="role-badge role-${role.toLowerCase().split(' ')[0]}">${role}</span>
                    <span class="badge ${status === 'Active' ? 'badge-success' : 'badge-danger'}">
                      ${status}
                    </span>
                  </div>
                </div>
              </div>
              
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                <div>
                  <h4><i class="fas fa-envelope"></i> Contact Information</h4>
                  <p><strong>Email:</strong> ${email}</p>
                  <p><strong>Phone:</strong> ${phone}</p>
                  <p><strong>Address:</strong> ${address}</p>
                </div>
                <div>
                  <h4><i class="fas fa-briefcase"></i> Work Information</h4>
                  <p><strong>Department:</strong> ${department}</p>
                  <p><strong>Role:</strong> ${role}</p>
                  <p><strong>Joined:</strong> ${joined}</p>
                  <p><strong>Employee ID:</strong> ${employeeId}</p>
                </div>
              </div>
              
              <div style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: var(--radius);">
                <h4><i class="fas fa-history"></i> Account Information</h4>
                <p><strong>Status:</strong> ${status}</p>
                <p><strong>Username:</strong> @${username}</p>
              </div>
            `;
        } else {
            modalBody.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h3>Error</h3><p>Employee data not found</p></div>`;
        }
    } catch (error) {
        console.error('Error loading employee details:', error);
        modalBody.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h3>Error</h3><p>Failed to load employee details</p></div>`;
    }
}

// Toggle employee status (activate/deactivate)
async function toggleEmployeeStatus(employeeId, action) {
    if (confirm(`Are you sure you want to ${action} this employee?`)) {
        try {
            const response = await fetch(`/toggle-status/${employeeId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('success', data.message);
                
                // Update the row in the table
                const row = document.querySelector(`tr[data-employee-id="${employeeId}"]`);
                if (row) {
                    const statusCell = row.querySelector('.badge-success, .badge-danger');
                    const newStatus = data.is_active ? 'Active' : 'Inactive';
                    const newStatusClass = data.is_active ? 'badge-success' : 'badge-danger';
                    
                    if (statusCell) {
                        statusCell.className = `badge ${newStatusClass}`;
                        statusCell.innerHTML = `<i class="fas fa-${data.is_active ? 'check' : 'times'}-circle"></i> ${newStatus}`;
                    }
                    
                    // Update row class
                    row.className = data.is_active ? 'active' : 'inactive';
                    
                    // Update the button
                    const statusBtn = row.querySelector('.action-buttons').lastElementChild;
                    if (statusBtn) {
                        if (data.is_active) {
                            statusBtn.className = 'btn btn-outline btn-xs btn-icon';
                            statusBtn.innerHTML = '<i class="fas fa-user-slash"></i>';
                            statusBtn.onclick = () => toggleEmployeeStatus(employeeId, 'deactivate');
                            statusBtn.title = 'Deactivate';
                        } else {
                            statusBtn.className = 'btn btn-success btn-xs btn-icon';
                            statusBtn.innerHTML = '<i class="fas fa-user-check"></i>';
                            statusBtn.onclick = () => toggleEmployeeStatus(employeeId, 'activate');
                            statusBtn.title = 'Activate';
                        }
                    }
                }
            } else {
                showNotification('error', data.error || 'Failed to update status');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('error', 'Failed to update employee status');
        }
    }
}

// Update the deleteEmployee function with better error handling
async function deleteEmployee(employeeId) {
    if (confirm('Are you sure you want to delete this employee? This action cannot be undone.')) {
        try {
            const response = await fetch(`/delete-employee/${employeeId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'  // Important for session/cookie authentication
            });
            
            // Check if response is OK
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('success', data.message);
                
                // Remove the row from the table
                const row = document.querySelector(`tr[data-employee-id="${employeeId}"]`);
                if (row) {
                    row.style.transition = 'all 0.3s ease';
                    row.style.opacity = '0';
                    row.style.transform = 'translateX(-100px)';
                    
                    // Remove row after animation
                    setTimeout(() => {
                        row.remove();
                        
                        // Check if table is empty
                        const tableBody = document.getElementById('employee-table-body');
                        if (tableBody && tableBody.children.length === 0) {
                            tableBody.innerHTML = `
                                <tr>
                                    <td colspan="7">
                                        <div class="empty-state">
                                            <i class="fas fa-users-slash"></i>
                                            <h3>No employees found</h3>
                                            <p>Try adjusting your filters or add new employees.</p>
                                            <button class="btn btn-primary" onclick="showAddEmployeeModal()" style="margin-top: 15px;">
                                                <i class="fas fa-user-plus"></i> Add First Employee
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }
                    }, 300);
                }
                
                // Refresh stats after 1 second
                setTimeout(() => {
                    refreshStats();
                }, 1000);
                
            } else {
                showNotification('error', data.error || 'Failed to delete employee');
            }
        } catch (error) {
            console.error('Delete error details:', error);
            showNotification('error', `Failed to delete employee: ${error.message}`);
        }
    }
}


async function refreshStats() {
    try {
        
        showNotification('info', 'Employee deleted. Page will refresh to update statistics.');
        setTimeout(() => {
            window.location.reload();
        }, 2000);
        
    } catch (error) {
        console.error('Error refreshing stats:', error);
    }
}
// Load employee data for editing
async function editEmployee(employeeId) {
    selectedEmployeeId = employeeId;
    
    try {
        const response = await fetch(`/edit-employee/${employeeId}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const employee = data.employee;
            
            // Fill the form with employee data
            document.getElementById('edit_employee_id').value = employee.id;
            document.getElementById('edit_username').value = employee.username;
            document.getElementById('edit_email').value = employee.email;
            document.getElementById('edit_first_name').value = employee.first_name || '';
            document.getElementById('edit_last_name').value = employee.last_name || '';
            document.getElementById('edit_phone_number').value = employee.phone_number;
            document.getElementById('edit_department').value = employee.department_id || '';
            document.getElementById('edit_address').value = employee.address || '';
            document.getElementById('edit_role').value = employee.role;
            document.getElementById('edit_is_active').checked = employee.is_active;
            
            // Update character count
            updateEditCharCount();
            
            // Update avatar preview
            updateEditAvatarPreview();
            
            // Clear password fields
            document.getElementById('edit_password1').value = '';
            document.getElementById('edit_password2').value = '';
            
            // Clear any previous errors
            document.querySelectorAll('#editEmployeeForm .error-messages').forEach(el => {
                el.innerHTML = '';
            });
            document.querySelectorAll('#editEmployeeForm .form-control.is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
            
            // Show the edit modal
            const modal = document.getElementById('editEmployeeModal');
            modal.classList.add('active');
            
        } else {
            showNotification('error', data.error || 'Failed to load employee data');
        }
    } catch (error) {
        console.error('Error loading employee data:', error);
        showNotification('error', 'Failed to load employee data');
    }
}

// Update employee in table after edit
function updateEmployeeInTable(employee) {
    const row = document.querySelector(`tr[data-employee-id="${employee.id}"]`);
    
    if (!row) return;
    
    // Update employee info
    const nameCell = row.querySelector('.employee-name');
    const usernameCell = row.querySelector('.employee-username');
    const emailCell = row.querySelector('.fa-envelope').parentNode;
    const phoneCell = row.querySelector('.fa-phone').parentNode;
    const deptCell = row.querySelector('.badge-primary, .badge-warning');
    const roleCell = row.querySelector('.role-badge');
    const statusCell = row.querySelector('.badge-success, .badge-danger');
    const statusClass = employee.status === 'Active' ? 'badge-success' : 'badge-danger';
    
    if (nameCell) {
        nameCell.textContent = employee.name;
    }
    
    if (usernameCell) {
        usernameCell.textContent = `@${employee.username}`;
    }
    
    if (emailCell) {
        emailCell.innerHTML = `<i class="fas fa-envelope"></i> ${employee.email}`;
    }
    
    if (phoneCell) {
        phoneCell.innerHTML = `<i class="fas fa-phone"></i> ${employee.phone}`;
    }
    
    if (deptCell) {
        deptCell.className = 'badge badge-primary';
        deptCell.innerHTML = `<i class="fas fa-building"></i> ${employee.department}`;
    }
    
    if (roleCell) {
        roleCell.className = `role-badge role-${employee.role.toLowerCase()}`;
        roleCell.innerHTML = `<i class="fas fa-user-tag"></i> ${employee.role}`;
    }
    
    if (statusCell) {
        statusCell.className = `badge ${statusClass}`;
        statusCell.innerHTML = `<i class="fas fa-${employee.status === 'Active' ? 'check' : 'times'}-circle"></i> ${employee.status}`;
    }
    
    // Update row class
    row.className = employee.status === 'Active' ? 'active' : 'inactive';
    
    // Update avatar image
    const avatarImg = row.querySelector('.employee-avatar');
    if (avatarImg) {
        avatarImg.src = employee.avatar_url;
        avatarImg.alt = employee.name;
    }
}

// Send message to employee (placeholder)
function sendMessage(employeeId) {
    alert(`Send message to employee ${employeeId}`);
}

// Show add employee modal
function showAddEmployeeModal() {
    const modal = document.getElementById('addEmployeeModal');
    modal.classList.add('active');
    
    // Clear form and errors
    if (document.getElementById('addEmployeeForm')) {
        document.getElementById('addEmployeeForm').reset();
        clearErrors();
        updateAvatarPreview();
        updateCharCount();
        checkPasswordStrength('');
    }
}

// Close all modals
function closeModal() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('active');
    });
}

// Export data to CSV
function exportData() {
    // Create CSV data
    const rows = document.querySelectorAll('#employee-table-body tr:not([style*="display: none"])');
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // Add headers
    const headers = ["Name", "Username", "Email", "Phone", "Department", "Role", "Status", "Joined Date"];
    csvContent += headers.join(",") + "\n";
    
    // Add data rows
    rows.forEach(row => {
        if (row.style.display !== 'none') {
            const cells = row.querySelectorAll('td');
            const name = cells[0].querySelector('.employee-name').textContent.trim();
            const username = cells[0].querySelector('.employee-username').textContent.trim().replace('@', '');
            const email = cells[0].querySelector('.fa-envelope').parentNode.textContent.trim();
            const phone = cells[1].querySelector('.fa-phone').parentNode.textContent.trim();
            const department = cells[2].querySelector('.badge-primary, .badge-warning')?.textContent.trim() || '';
            const role = cells[3].querySelector('.role-badge').textContent.trim();
            const status = cells[4].querySelector('.badge-success, .badge-danger')?.textContent.trim() || '';
            const joined = cells[5].querySelector('div:first-child').textContent.trim();
            
            const rowData = [name, username, email, phone, department, role, status, joined]
                .map(cell => `"${cell.replace(/"/g, '""')}"`)
                .join(",");
            csvContent += rowData + "\n";
        }
    });
    
    // Create download link
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "employees_export.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Toggle view (placeholder)
function toggleView() {
    alert('Grid view will be implemented in the next update');
}

// Refresh data
function refreshData() {
    window.location.reload();
}

// Add employee to table (for immediate UI update)
function addEmployeeToTable(employee) {
    const tableBody = document.getElementById('employee-table-body');
    
    if (!tableBody) return;
    
    const newRow = document.createElement('tr');
    newRow.className = employee.status === 'Active' ? 'active' : 'inactive';
    newRow.setAttribute('data-employee-id', employee.id);
    
    newRow.innerHTML = `
        <td>
            <div class="employee-info">
                <img 
                    class="employee-avatar"
                    src="${employee.avatar_url}"
                    alt="${employee.name}"
                    onerror="this.src='https://ui-avatars.com/api/?name=User&background=4361ee&color=fff&size=45'"
                />
                <div class="employee-details">
                    <div class="employee-name">${employee.name}</div>
                    <div class="employee-username">@${employee.username}</div>
                    <div style="font-size: 0.8rem; color: var(--gray);">
                        <i class="fas fa-envelope"></i> ${employee.email}
                    </div>
                </div>
            </div>
        </td>
        <td>
            <div style="font-weight: 500;">
                <i class="fas fa-phone"></i> ${employee.phone}
            </div>
        </td>
        <td>
            <span class="badge badge-primary">
                <i class="fas fa-building"></i> ${employee.department}
            </span>
        </td>
        <td>
            <span class="role-badge role-${employee.role.toLowerCase()}">
                <i class="fas fa-user-tag"></i> ${employee.role}
            </span>
        </td>
        <td>
            <span class="badge badge-${employee.status === 'Active' ? 'success' : 'danger'}">
                <i class="fas fa-${employee.status === 'Active' ? 'check' : 'times'}-circle"></i> ${employee.status}
            </span>
        </td>
        <td>
            <div style="font-weight: 500;">${employee.created_at}</div>
            <div style="font-size: 0.85rem; color: var(--gray);">
                just now
            </div>
        </td>
        <td>
            <div class="action-buttons">
                <button class="btn btn-primary btn-xs btn-icon" onclick="viewEmployee('${employee.id}')" title="View">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-outline btn-xs btn-icon" onclick="editEmployee('${employee.id}')" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-outline btn-xs btn-icon" onclick="sendMessage('${employee.id}')" title="Message">
                    <i class="fas fa-envelope"></i>
                </button>
                <button class="btn btn-outline btn-xs btn-icon" onclick="toggleEmployeeStatus('${employee.id}', 'deactivate')" title="Deactivate">
                    <i class="fas fa-user-slash"></i>
                </button>
                <button class="btn btn-outline btn-xs btn-icon" onclick="deleteEmployee('${employee.id}')" title="Delete" style="color: var(--danger); border-color: var(--danger);">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    `;
    
    // Add to the beginning of the table
    if (tableBody.firstChild) {
        tableBody.insertBefore(newRow, tableBody.firstChild);
    } else {
        tableBody.appendChild(newRow);
    }
}

// Handle add employee form submission
document.getElementById('addEmployeeForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = document.getElementById('submitEmployeeBtn');
    const btnText = submitBtn?.querySelector('.btn-text');
    const loader = submitBtn?.querySelector('.loader');
    
    // Show loading state
    if (btnText) btnText.style.display = 'none';
    if (loader) loader.style.display = 'block';
    if (submitBtn) submitBtn.disabled = true;
    
    try {
        const formData = new FormData(form);
        
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Success - close modal and show success message
            closeModal();
            
            // Show success message
            showNotification('success', data.message || 'Employee added successfully!');
            
            // Add the new employee to the table
            if (data.employee) {
                addEmployeeToTable(data.employee);
            }
            
            // Refresh the page after 2 seconds to show updated stats
            setTimeout(() => {
                window.location.reload();
            }, 2000);
            
        } else {
            // Show errors
            showErrors(data.errors || {});
            showNotification('error', 'Please correct the errors below.');
        }
        
    } catch (error) {
        console.error('Error:', error);
        showNotification('error', 'An error occurred. Please try again.');
    } finally {
        // Reset button state
        if (btnText) btnText.style.display = 'inline';
        if (loader) loader.style.display = 'none';
        if (submitBtn) submitBtn.disabled = false;
    }
});

// Handle edit form submission
document.getElementById('editEmployeeForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = document.getElementById('submitEditEmployeeBtn');
    const btnText = submitBtn?.querySelector('.btn-text');
    const loader = submitBtn?.querySelector('.loader');
    const employeeId = document.getElementById('edit_employee_id').value;
    
    // Show loading state
    if (btnText) btnText.style.display = 'none';
    if (loader) loader.style.display = 'block';
    if (submitBtn) submitBtn.disabled = true;
    
    try {
        const formData = new FormData(form);
        
        const response = await fetch(`/edit-employee/${employeeId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Success - close modal and show success message
            closeModal();
            showNotification('success', data.message || 'Employee updated successfully!');
            
            // Update the row in the table
            updateEmployeeInTable(data.employee);
            
        } else {
            // Show errors
            showErrors(data.errors || {});
            showNotification('error', 'Please correct the errors below.');
        }
        
    } catch (error) {
        console.error('Error:', error);
        showNotification('error', 'An error occurred. Please try again.');
    } finally {
        // Reset button state
        if (btnText) btnText.style.display = 'inline';
        if (loader) loader.style.display = 'none';
        if (submitBtn) submitBtn.disabled = false;
    }
});

// Close modal when clicking outside
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl + F for search
    if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        const searchInput = document.getElementById('live-search') || document.getElementById('search');
        if (searchInput) searchInput.focus();
    }
    // Escape to close modals
    if (e.key === 'Escape') {
        closeModal();
    }
});

// Smooth scroll to top button
const scrollToTopBtn = document.createElement('button');
scrollToTopBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
scrollToTopBtn.style.cssText = `
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: var(--shadow-lg);
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    z-index: 100;
    transition: all 0.3s;
`;

scrollToTopBtn.onmouseover = () => scrollToTopBtn.style.transform = 'translateY(-3px)';
scrollToTopBtn.onmouseout = () => scrollToTopBtn.style.transform = 'translateY(0)';
scrollToTopBtn.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });

document.body.appendChild(scrollToTopBtn);

window.addEventListener('scroll', () => {
    scrollToTopBtn.style.display = window.scrollY > 300 ? 'flex' : 'none';
});

// Add keyframe animations for notifications
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);

// Add event listeners for real-time updates
document.addEventListener('DOMContentLoaded', function() {
    // Update avatar when name changes in add form
    ['id_first_name', 'id_last_name'].forEach(id => {
        const field = document.getElementById(id);
        if (field) {
            field.addEventListener('input', updateAvatarPreview);
        }
    });
    
    // Update avatar when name changes in edit form
    ['edit_first_name', 'edit_last_name'].forEach(id => {
        const field = document.getElementById(id);
        if (field) {
            field.addEventListener('input', updateEditAvatarPreview);
        }
    });
    
    // Update character count for address in add form
    const addressField = document.getElementById('id_address');
    if (addressField) {
        addressField.addEventListener('input', updateCharCount);
        updateCharCount(); // Initial count
    }
    
    // Update character count for address in edit form
    const editAddressField = document.getElementById('edit_address');
    if (editAddressField) {
        editAddressField.addEventListener('input', updateEditCharCount);
        updateEditCharCount(); // Initial count
    }
    
    // Password strength checker
    const passwordField = document.getElementById('id_password1');
    if (passwordField) {
        passwordField.addEventListener('input', function() {
            checkPasswordStrength(this.value);
        });
    }
    
    // Phone number validation for add form
    const phoneField = document.getElementById('id_phone_number');
    if (phoneField) {
        phoneField.addEventListener('input', function() {
            // Remove non-numeric characters
            this.value = this.value.replace(/\D/g, '');
            
            // Show warning if not within range
            if (this.value.length < 10 || this.value.length > 15) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }
    
    // Phone number validation for edit form
    const editPhoneField = document.getElementById('edit_phone_number');
    if (editPhoneField) {
        editPhoneField.addEventListener('input', function() {
            // Remove non-numeric characters
            this.value = this.value.replace(/\D/g, '');
            
            // Show warning if not within range
            if (this.value.length < 10 || this.value.length > 15) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }
});
    </script>
  </body>
</html>